<script type="text/javascript">
  // Make the railsIdLookup, which looks up a unique id for each  URL / identifier pair.
  // Allows us to have shorter class names and avoid illegal characters in a class which might exist in a URL.
  var railsIdLookup = { };

  <%= @datasets.reject{ |d| d.finalized == false }
               .uniq{ |x| x.server_url + x.identifier }
               .map{ |d| "railsIdLookup[makeKey('" + d.server_url + "','" + d.identifier + "')] = '" + d.id.to_s + "';\n" }
               .join(' ') %>


  var serverDatasets  = { };

  // Create an association between a server and all registered datasets it hosts
  // Creates a series of lines that look like this:
  //  serverDatasets['http://montreuil.dynmap.com/carte_pour_iguess/carteWS.php'] = ['_IRIS99_montreuil_cc49', 'Bati_remarquable',
  //     '_domaine_non_cadastre_2011', 'Cimetiere_line', '_domaine_non_cadastr__2011_CC49', '_IRIS99_montreuil_cc49_line'];
  //
  <% @server_urls.each do |url| %>    <%# These could be wms, wfs, or wcs addresses %>
    serverDatasets['<%= url.gsub(/\\/, '\\\\\\') %>'] = [<%= @datasets.reject {|d| d.server_url != url}
                                                                    .map{|d| "'" + d.identifier + "'"}
                                                                    .join(', ') %>];
  <% end %>
</script>
